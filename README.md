# far-gvfs (gvfspanel)

Бета-версия, **использовать с осторожностью!**

_Только для особо интересующихся._

Очень простое дополнение к [far2l](https://github.com/elfmz/far2l). Обертка
вокруг GVFS: позволяет работать с сетевыми ресурсами как с виртуальными
файловыми системами. Поддерживаются те протоколы, которые поддерживает GVFS
(SFTP, WebDAV, SAMBA и др.).

#### Лицензия: MIT

Использован код из https://github.com/invy/far2l/tree/gvfs/gvfspanel.

## Зависимости

* gtkmm-3.0 (возможно, будет работать и с более ранней 2 версией);
* libuuid;
* OpenSSL версии 1.0.2 и старше (необязательная);
* libsecret версии 0.18.5 и старше (необязательная).

Установки зависимостей сборки в Debian (Ubuntu):

```
apt-get install libgtkmm-3.0-dev uuid-dev libssl-dev libsecret-1-dev
```

В зависимости от наличия libsecret и OpenSSL дополнение по-разному хранит
пароли. Если имеется libsecret, то пароли могут храниться в системных
безопасных хранилищах: Gnome Keyring или KDE Wallet. OpenSSL используется для
шифрования хранимых паролей, если безопасное хранилище не задействовано или
дополнение собрано без его поддержки. И наконец, если дополнение собирается
без OpenSSL и поддержки безопасного хранилища (или оно не используется), то
_пароли хранятся практически незашифрованными_!

Для сборки дополнение помещается в дерево исходного кода far2l в виде
поддиректории, например, если код far2l развернут в директорию "far2l",
то код far-gvfs помещается в "far2l/far-gvfs". Затем директорию добавляют
в проектный файл "CMakeLists.txt" far2l:

```
...
add_subdirectory (align)
add_subdirectory (autowrap)
add_subdirectory (drawline)
add_subdirectory (far-gvfs)
...
```

Дополнение будет собрано и подготовлено к установке вместе с прочими
дополнениями far2l, входящими в его состав.

Для работы дополнения в целевой ОС должны быть установлены:

* gtkmm;
* поддержка GVFS;
* libuuid (пакет libuuid1 в Debian);
* libssl (необязательно);
* libsecret (пакет libsecret-1, необязательно).

## Возможности

Для монтирования сетевых ресурсов необходимо указать URL ресурса, учетную
запись и пароль для нужд аутентификации. Анонимное монтирование возможно:
попытки анонимного подключения выполняются, если и учетная запись, и пароль
_не указаны_. Вместо хранения пароля можно запрашивать его перед каждым
монтированием ресурса. В ходе подключения пользователю может быть сделан
запрос с выбором вариантов дальнейших действий. Формулировки запроса и
вариантов зависят от используемого протокола. Дополнение представляет их
в том виде, в каком получает от GVFS. Аналогично, в случае возникновения
каких-либо ошибок о них выдается сообщение, переданное GVFS. В случае удачного
завершения операции панель GVFS переключается на вновь подсоединенный ресурс.
Ресурсы в статусе подсоединенных в списке помечаются знаком "*". Отсоединить
ресурс можно, нажав Shift-F8. Статусы ресурсов на панели обновляются по
нажатию Ctrl-R.

В зависимости от настроек дополнения, известные смонтированные ресурсы при
завершении работы с far2l можно автоматически отсоединять. Если запущено более
одного экземпляра far2l, то они пользуются общим (системным) пулом
смонтированных ресурсов. Таким образом, разрешение всех возможных конфликтов в
работе с ресурсами оставлено средствам самой GVFS.

Данные о сетевых ресурсах хранятся в реестре far2l в ветке
"Software/Far2/gvfspanel/Resources". В зависимости от настроек дополнения
пароли могут храниться отдельно в системных безопасных хранилищах. Если ранее
сохраненные данные перестали отображаться на панели или неправильно
загружаются, удалите ветку целиком и заведите ресурсы заново. Пароли в
системных хранилищах помечаются как "Far-gvfs password record". При удалении
ветки реестра рекомендуется вручную удалить и пароли в стороннем хранилище. В
случае, если пароль из стороннего хранилища извлечь не удалось, то запись о
ресурсе не отбрасывается. Пользователь сможет ввести пароль заново.

Дополнение добавляется в меню выбора устройств far2l под именем "GVFS", а
также в меню конфигурации и команд дополнений. Параметры конфигурации far-gvfs:

* отсоединять или нет известные смонтированные ресурсы при выходе из far2l. По
  умолчанию отсоединяются.
* использовать или нет для хранения паролей системные безопасные хранилища. По
  умолчанию не используются. Параметр может отсутствовать, если дополнение
  собрано без поддержки безопасных хранилищ.

Команды:

* переключение текущей панели на панель самого дополнения.

## Известные проблемы

Симптомы|Вероятная причина|Комментарий
--------|-----------------|-----------
Ошибка 20005 при монтировании|Некоторые задержки в GVFS.|В основном безвредна, потому что ресурс фактически монтируется успешно. Подробности в [#14](https://github.com/cycleg/far-gvfs/issues/14).
Ошибка 2 при монтировании и переключение на локальную директорию|Указанного в URL ресурса не существует.|Домашняя директория аутентифицированного пользователя доступна, поэтому ресурс отображается как подсоединенный.
После подсоединения на панели отображается пустая директория.|У аутентифицированного пользователя нет прав на доступ к запрошенному ресурсу.|То же, что и в предыдущем случае.
Ошибка 2 при различных файловых операциях с использованием FTP в качестве транспорта.|Ошибки в реализации GVFS поверх FTP.| Это не проблема far-gvfs, потому что такие же проблемы проявляются и в других приложениях, работающих с GVFS.

## Документация

Исходный код дополнения документирован с помощью doxygen. Для построения
документации достаточно отдать в корне дерева кода команду:

```
doxygen Doxyfile
```

Документация в формате HTML будет помещена в директорию "docs/html".
